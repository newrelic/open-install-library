metadata:
  #TBD: id ?
  name: Infrastructure Agent Linux Installer
  description: New Relic install recipe for the Infrastructure agent
  repository: https://github.com/newrelic/infrastructure-agent

  # Some variable/indicator for where you're trying to install this that isn't necessarily where you're running the newrelic-cli from
  # See http://download.newrelic.com/infrastructure_agent/ for possible permutations
  variant:
    platform:
      - linux
    arch:
      - "386"
    targetEnvironment:
      - vm

  # keyword convention for dealing with search terms that could land someone on this instrumentation project
  keywords:
    - Sample

  # tag convention for dealing with search terms that could land someone on this instrumentation project
  tags:
    - Node
    - Node.js
    - Microsoft Azure Web Apps

  # Examine Infrastructure events for correlated data
  processMatch:
    - /infra/

  # Examine Metrics, Events, and Logging for correlated data
  # Used by the UI to determine if you've successfully configured and are ingesting data
  meltMatch:
    events:
      pattern:
        - /SystemSample/
    metrics:
      pattern:
        - /system.cpu.usage/
    logging:
      pattern:
        - /http/
      files:
        - /var\/log\/system.log

install:
  # go-task yaml definition goes here
  # This spec - https://github.com/go-task/task

  version: "3"

  env:
    NR_LICENSE_KEY: "{{.NR_LICENSE_KEY}}"

  variables:
    - FOO_VAR: foo-value

  tasks:
    install:
      cmds:
        - task: setup_nr_profile
        - task: install_infra

    setup_nr_profile:
      cmds:
        - echo "Setting up NR Profile"

    install_infra:
      cmds:
        - echo "Installing the Infrastructure agent"
        - curl -L https://raw.githubusercontent.com/fryckbos/infra-install/master/install.sh {{.NR_LICENSE_KEY}} | sh
      silent: true
