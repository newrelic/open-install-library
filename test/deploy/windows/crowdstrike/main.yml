---
- debug:
    msg: Deploy CrowdStrike Falcon Sensor (Windows)

- name: Make downloads directory if doesn't exist
  win_file:
    path: C:\\Users\\ansible\\Downloads
    state: directory

- name: Install CrowdStrike Falcon Sensor
  block:
    - include_role:
        name: newrelic.crowdstrike_provision.install_crowdstrike_falcon
  vars:
    falcon_client_id: "{{ lookup('env', 'CROWDSTRIKE_CLIENT_ID') }}"
    falcon_client_secret: "{{ lookup('env', 'CROWDSTRIKE_CLIENT_SECRET') }}"
    falcon_customer_id: "{{ lookup('env', 'CROWDSTRIKE_CUSTOMER_ID') }}"
    api_base_url: "https://api.laggar.gcw.crowdstrike.com"

# - name: Validate sensor is running
#   shell: ps -e | grep falcon-sensor | grep -v grep | wc -l
#   register: is_sensor_running
#   become: true

# - name: Ensure Falcon is started
#   ansible.builtin.fail:
#     msg: falcon-sensor is not running
#   when: is_sensor_running.stdout|int == 0
