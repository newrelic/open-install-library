---
- name: Debug OS Family
  debug:
    var: ansible_facts['os_family']

- name: Debug ansible_user
  debug:
    var: ansible_user

- name: Debug ansible_become_method
  debug:
    msg: "{{ (ansible_facts['os_family'] == 'Windows') | ternary('runas', 'sudo') }}"

- name: Debug ansible_become_user
  debug:
    msg: "{{ (ansible_facts['os_family'] == 'Windows') | ternary('Administrator', 'root') }}"

- name: Install CrowdStrike Falcon Sensor (Linux)
  become: true
  block:
    - include_role:
        name: newrelic.crowdstrike_provision.install_crowdstrike_falcon
  vars:
    falcon_client_id: "{{ lookup('env', 'CROWDSTRIKE_CLIENT_ID') }}"
    falcon_client_secret: "{{ lookup('env', 'CROWDSTRIKE_CLIENT_SECRET') }}"
    falcon_customer_id: "{{ lookup('env', 'CROWDSTRIKE_CUSTOMER_ID') }}"
    api_base_url: "https://api.laggar.gcw.crowdstrike.com"
  when: ansible_facts['os_family'] != 'Windows'

- name: Install CrowdStrike Falcon Sensor (Windows)
  become: true
  become_method: runas
  become_user: SYSTEM
  block:
    - name: Create ansible downloads directory
      ansible.windows.win_file:
      path: "C:\Users\ansible\Downloads"
      state: directory

    - include_role:
        name: newrelic.crowdstrike_provision.install_crowdstrike_falcon
  vars:
    falcon_client_id: "{{ lookup('env', 'CROWDSTRIKE_CLIENT_ID') }}"
    falcon_client_secret: "{{ lookup('env', 'CROWDSTRIKE_CLIENT_SECRET') }}"
    falcon_customer_id: "{{ lookup('env', 'CROWDSTRIKE_CUSTOMER_ID') }}"
    api_base_url: "https://api.laggar.gcw.crowdstrike.com"
  when: ansible_facts['os_family'] == 'Windows'
