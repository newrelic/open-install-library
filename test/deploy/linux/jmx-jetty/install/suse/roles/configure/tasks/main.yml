---
- debug:
    msg: Install JETTY-JMX

- name: Download java
  shell: 'curl -v -j -k -L -H "Cookie: oraclelicense=accept-securebackup-cookie" http://download.oracle.com/otn-pub/java/jdk/8u131-b11/d54c1d3a095b4ff2b6607d096fa80163/jdk-8u131-linux-x64.rpm > jdk-8u112-linux-x64.rpm'
  become: true

- name: Install java
  shell: rpm -ihv jdk-8u112-linux-x64.rpm
  become: true

- name: Add java to env
  shell: /usr/sbin/update-alternatives --install /usr/bin/java java /usr/java/latest/bin/java 20000 --slave /usr/bin/keytool keytool /usr/java/latest/bin/keytool --slave /usr/bin/orbd orbd /usr/java/latest/bin/orbd --slave /usr/bin/pack200 pack200 /usr/java/latest/bin/pack200 --slave /usr/bin/policytool policytool /usr/java/latest/bin/policytool --slave /usr/bin/rmid rmid /usr/java/latest/bin/rmid --slave /usr/bin/rmiregistry rmiregistry /usr/java/latest/bin/rmiregistry --slave /usr/bin/tnameserv tnameserv /usr/java/latest/bin/tnameserv --slave /usr/bin/unpack200 unpack200 /usr/java/latest/bin/unpack200
  become: true

- name: Fix java errors
  shell: /usr/sbin/update-alternatives --auto java
  become: true

- name: download jetty
  shell: wget https://repo1.maven.org/maven2/org/eclipse/jetty/jetty-distribution/9.4.17.v20190418/jetty-distribution-9.4.17.v20190418.tar.gz
  become: true 

- name: Download CometD
  shell: wget https://download.cometd.org/cometd-5.0.0-distribution.tar.gz
  become: true

- name: Extract CometD
  shell: tar zxvf cometd-5.0.0-distribution.tar.gz
  become: true

- name: extract jetty
  shell: tar -zxvf jetty-distribution-9.4.17.v20190418.tar.gz
  become: true 

- name: move jetty directory to opt
  shell: mv jetty-distribution-9.4.17.v20190418 /opt/jetty
  become: true

- name: Create user
  shell: useradd -m jetty
  become: true 

- name: change ownership of jetty
  shell: chown -R jetty /opt/jetty/
  become: true 

- name: Create jetty pid
  shell: mkdir /var/run/jetty
  become: true 

- name: Change ownership of jetty pid
  shell: chown -R jetty /var/run/jetty
  become: true 

- name: Create symlink
  shell: ln -s /opt/jetty/bin/jetty.sh /etc/init.d/jetty
  become: true 

- name: add jetty web server to the startup
  shell: chkconfig --add jetty
  become: true 

- name: Create jetty base
  shell: mkdir /opt/jetty/my_base/
  become: true 

- name: Allow user to write files in jetty base
  shell: chown -R jetty /opt/jetty/my_base/
  become: true 

- name: Replace jetty file
  template:
    src: jetty
    dest: /etc/default/jetty
  become: true

- name: Replace start.ini file
  template:
    src: start.ini
    dest: /opt/jetty/my_base/start.ini
  become: true

- name: Add CometD war file
  shell: cp cometd-5.0.0/cometd-demo/target/cometd-demo-5.0.0.war /opt/jetty/my_base/webapps/
  become: true

- name: daemon reload
  shell: systemctl daemon-reload
  become: true 

- name: start jetty
  shell: service jetty start
  become: true

- name: Export USERNAME
  shell: "echo export NR_CLI_JMX_USERNAME=admin >> ~/.bashrc"

- name: Export PASSWORD
  shell: "echo export NR_CLI_JMX_PASSWORD=admin >> ~/.bashrc"

- name: Export HOSTNAME
  shell: "echo export NR_CLI_JMX_HOST=localhost >> ~/.bashrc"

- name: Export DB_PORT
  shell: "echo export NR_CLI_JMX_PORT=9999 >> ~/.bashrc"

- name: Export Enable_SSL
  shell: "echo export NR_CLI_SSL_ENABLED=n >> ~/.bashrc"

- name: Export KEYSTORE
  shell: "echo export NR_CLI_KEYSTORE=notUsed >> ~/.bashrc"

- name: Export KEYSTORE_PASSWORD
  shell: "echo export NR_CLI_KEYSTORE_PASSWORD=notUsed >> ~/.bashrc"

- name: Export TRUST STORE
  shell: "echo export NR_CLI_TRUSTSTORE=notUsed >> ~/.bashrc"

- name: Export TRUST STORE PASSWORD
  shell: "echo export NR_CLI_TRUSTSTORE_PASSWORD=notUsed >> ~/.bashrc"

