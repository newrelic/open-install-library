---

- name: Install Microk8s
  shell: "apt update && apt install snapd -y && snap install microk8s --classic"
  become: yes 
 
- name: Enable Microk8s
  shell: "microk8s enable dns dashboard storage"
  become: yes

- name: Add user to microk8s group
  shell: "usermod -a -G microk8s {{ ansible_user }} && chown -f -R {{ ansible_user }} ~/.kube"
  become: yes

- name: Apply group changes
  shell: "newgrp microk8s"
  become: yes

- name: Generate kubeconfig
  shell: "microk8s config > ~/.kube/config"
  become: yes

- name: Add kubeconfig to env path
  shell: "export KUBECONFIG=$HOME/.kube/microk8s-config && export KUBECONFIG=/home/ubuntu/.kube/microk8s-config && echo 'export KUBECONFIG=$KUBECONFIG:~/.kube/config' >> ~/.bashrc && source"
  become: yes

- name: Add node
  shell: "microk8s add-node"
  become: yes