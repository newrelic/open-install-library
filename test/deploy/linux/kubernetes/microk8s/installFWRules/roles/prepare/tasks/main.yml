---

- name: Ensure /etc/iptables directory exists
  file:
    path: /etc/iptables
    state: directory
    mode: '0755'
  become: yes

- name: Allow TCP traffic on port 16433
  ansible.builtin.iptables:
    chain: INPUT
    protocol: tcp
    destination_port: 16433
    jump: ACCEPT
    state: present
  become: yes

- name: Allow all traffic from the subnet
  ansible.builtin.iptables:
    chain: INPUT
    source: 172.31.0.0/20
    jump: ACCEPT
    state: present
  become: yes

- name: Allow TCP traffic on port 8081
  ansible.builtin.iptables:
    chain: INPUT
    protocol: tcp
    destination_port: 8081
    jump: ACCEPT
    state: present
  become: yes

- name: Install iptables-persistent package
  ansible.builtin.apt:
    name: iptables-persistent
    state: present
  become: yes

- name: Change ownership of /etc/iptables/rules.v4 to ubuntu user
  ansible.builtin.file:
    path: /etc/iptables/rules.v4
    owner: ubuntu
    group: ubuntu
    mode: '0644'
  become: yes

- name: Restart iptables-persistent service to apply rules
  ansible.builtin.service:
    name: netfilter-persistent
    state: restarted
    enabled: yes
  become: yes