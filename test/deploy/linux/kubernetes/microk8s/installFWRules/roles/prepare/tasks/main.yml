---

- name: Ensure /etc/iptables directory exists
  file:
    path: /etc/iptables
    state: directory
    mode: '0755'
  become: yes

- name: Set default policy for INPUT chain to ACCEPT
  ansible.builtin.iptables:
    chain: INPUT
    policy: ACCEPT
    state: present
  become: yes

- name: Set default policy for FORWARD chain to ACCEPT
  ansible.builtin.iptables:
    chain: FORWARD
    policy: ACCEPT
    state: present
  become: yes

- name: Set default policy for OUTPUT chain to ACCEPT
  ansible.builtin.iptables:
    chain: OUTPUT
    policy: ACCEPT
    state: present
  become: yes

- name: Allow all traffic from subnet ip-10-1-0-0/16 to anywhere in FORWARD chain
  ansible.builtin.iptables:
    chain: FORWARD
    source: 10.1.0.0/16
    jump: ACCEPT
    comment: "generated for MicroK8s pods"
    state: present
  become: yes

- name: Allow all traffic to subnet ip-10-1-0-0/16 from anywhere in FORWARD chain
  ansible.builtin.iptables:
    chain: FORWARD
    destination: 10.1.0.0/16
    jump: ACCEPT
    comment: "generated for MicroK8s pods"
    state: present
  become: yes

- name: Allow TCP traffic on port 16433
  ansible.builtin.iptables:
    chain: INPUT
    protocol: tcp
    destination_port: 16433
    jump: ACCEPT
    state: present
  become: yes

- name: Allow all traffic from the subnet
  ansible.builtin.iptables:
    chain: INPUT
    source: 172.31.0.0/20
    jump: ACCEPT
    state: present
  become: yes

- name: Allow TCP traffic on port 8081
  ansible.builtin.iptables:
    chain: INPUT
    protocol: tcp
    destination_port: 8081
    jump: ACCEPT
    state: present
  become: yes

- name: Allow ICMP echo-request (ping) in INPUT chain
  ansible.builtin.iptables:
    chain: INPUT
    protocol: icmp
    icmp_type: echo-request
    jump: ACCEPT
    state: present
  become: yes

- name: Allow ICMP echo-reply (ping response) in OUTPUT chain
  ansible.builtin.iptables:
    chain: OUTPUT
    protocol: icmp
    icmp_type: echo-reply
    jump: ACCEPT
    state: present
  become: yes

- name: Install iptables-persistent package
  ansible.builtin.apt:
    name: iptables-persistent
    state: present
  become: yes

- name: Change ownership of /etc/iptables/rules.v4 to ubuntu user
  ansible.builtin.file:
    path: /etc/iptables/rules.v4
    owner: ubuntu
    group: ubuntu
    mode: '0644'
  become: yes

- name: Restart iptables-persistent service to apply rules
  ansible.builtin.service:
    name: netfilter-persistent
    state: restarted
    enabled: yes
  become: yes