---
- debug:
    msg: Install .NET App

- name: Set default download url for web app
  set_fact:
    web_app_url: "https://virtuoso-testing.s3-us-west-2.amazonaws.com/virt-coreapp.zip"
  when: web_app_url is undefined

- name: Update packages
  shell: |
    apt update
    apt upgrade -y
  become: true

# - name: Install depends
#   shell: yum install libicu unzip -y
#   become: true

- name: Copy web app service file
  template:
    src: kestrel-coreapp.service
    dest: /etc/systemd/system/kestrel-coreapp.service
  become: true

- name: Install and start web app
  shell: |
    mkdir -p /var/www/coreapp
    url="{{ web_app_url }}"
    curl $url -o /tmp/virt-coreapp.zip
    unzip /tmp/virt-coreapp.zip -d /var/www/coreapp
    chmod -R 777 /var/www/coreapp
    chown -R ubuntu:ubuntu /var/www/coreapp
    systemctl start kestrel-coreapp.service
  become: true

- name: Copy nxinx sites-enabled file
  template:
    src: default-nginx-site
    dest: /etc/nginx/sites-available/default
  become: true

- name: Restart Nginx
  shell: |
    nginx -t
    nginx -s reload
  become: true