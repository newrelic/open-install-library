---
- debug:
    msg: Install Memcached

- name: Set default create_env_var (default not create)
  set_fact:
    create_env_var: "false"
  when: create_env_var is undefined

- name: Install Memcached and sasl2
  apt:
    name: ['memcached', 'sasl2-bin']
    update_cache: yes
    state: latest
  become: true

- name: Copy memcached repo file
  template:
    src: memcached.conf
    dest: /etc/memcached.conf
  become: true

- name: Restart memcached
  shell: "systemctl restart memcached"
  become: true

- name: Create sasl dir
  shell: mkdir /etc/sasl2
  become: true

- name: Copy sasl file
  template:
    src: sasl/memcached.conf
    dest: /etc/sasl2/memcached.conf
  become: true

- name: Create sasl user
  shell: echo test | saslpasswd2 -a memcached -c -f /etc/sasl2/memcached-sasldb2 user
  become: true

- name: Change ownership of sasl db
  shell: chown memcache:memcache /etc/sasl2/memcached-sasldb2
  become: true

- name: Start memcached service
  shell: "systemctl restart memcached"
  become: true

- block:
  - name: Export USERNAME
    shell: echo export NR_CLI_USERNAME=user >> ~/.bashrc
  - name: Export PASSWORD
    shell: echo export NR_CLI_PASSWORD=test >> ~/.bashrc
  - name: Export HOSTNAME
    shell: "echo export NR_CLI_HOSTNAME=localhost >> ~/.bashrc"
  - name: Export PORT
    shell: "echo export NR_CLI_PORT=11211 >> ~/.bashrc"
  when: create_env_var|bool
