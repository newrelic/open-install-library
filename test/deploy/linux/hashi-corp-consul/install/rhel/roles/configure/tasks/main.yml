---
- debug:
    msg: Install HashiCorp Consul

- name: Update packages
  shell: yum update -y
  become: true

- name: Install yum utils
  shell: yum install -y yum-utils
  become: true

- name: Add official HashiCorp Linux Repository
  shell: sudo yum-config-manager --add-repo https://rpm.releases.hashicorp.com/AmazonLinux/hashicorp.repo
  become: true

- name: Install HashiCorp Consul
  shell: yum install consul -y
  become: true 

- name: Create consul config directory
  shell: mkdir -p ~/consul-config/server
  become: true

- name: Add consul server config file
  template:
    src: config.json
    dest: ~/consul-config/server/config.json
  become: true

- name: Export NR_CLI_HOSTNAME
  shell: "echo export NR_CLI_HOSTNAME=localhost >> ~/.bashrc"

- name: Export NR_CLI_PORT
  shell: "echo export NR_CLI_PORT=8500 >> ~/.bashrc"

- name: Export NR_CLI_TOKEN
  shell: "echo export NR_CLI_TOKEN= >> ~/.bashrc"

- name: Export NR_CLI_ENABLE_SSL
  shell: "echo export NR_CLI_ENABLE_SSL=n >> ~/.bashrc"

- name: Export NR_CLI_BUNDLE_DIR
  shell: "echo export NR_CLI_CA_BUNDLE_DIR= >> ~/.bashrc"

- name: Export NR_CLI_FILE_DIR
  shell: "echo export NR_CLI_CA_BUNDLE_DIR= >> ~/.bashrc"

- name: Start consule server
  shell: sudo consul agent -config-dir ~/consul-config/server -client=0.0.0.0
  become: true
