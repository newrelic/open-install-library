metadata:
  # name: Flex integration
  description: New Relic install recipe for installing the Flex integration
  repository: https://github.com/newrelic/nri-flex

  # See http://download.newrelic.com/infrastructure_agent/ for possible permutations
  variant:
    os:
      - linux
    arch:
      - "386"
    target_environment:
      - "vm"

  # keyword convention for dealing with search terms that could land someone on this instrumentation project
  keywords:
    - Flex

  # Examine Infrastructure events for correlated data
  process_match:
    - /logs/

  # Examine Metrics, Events, and Logging for correlated data
  # Used by the UI to determine if you've successfully configured and are ingesting data
  melt_match:
    events:
      pattern:
        - /flexStatusSample/

install:
  version: "3"

  tasks:
    default:
      cmds:
        - task: setup

    setup:
      cmds:
        - |
          sudo mkdir -p "/etc/newrelic-infra/integrations.d"
        - |
          if [ -f /etc/newrelic-infra/integrations.d/integrations.yml ]; then
            sudo rm /etc/newrelic-infra/integrations.d/integrations.yml;
          fi

          sudo touch /etc/newrelic-infra/integrations.d/integrations.yml;

        - |
          sudo tee -a /etc/newrelic-infra/integrations.d/integrations.yml > /dev/null <<"EOT"
          integrations:
            - name: nri-flex
              config:
                name: linuxFileSystemIntegration
                apis:
                  - name: FileSystem
                    commands:
                      - run: 'df -PT -B1 -x tmpfs -x xfs -x vxfs -x btrfs -x ext -x ext2 -x ext3 -x ext4'
                        split: horizontal
                        split_by: \s+
                        row_start: 1
                        set_header: [fs,fsType,capacityBytes,usedBytes,availableBytes,usedPerc,mountedOn]
                    perc_to_decimal: true
          EOT
        - sudo systemctl restart newrelic-infra.service
