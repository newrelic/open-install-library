name: Infrastructure Agent Installer for Windows
description: New Relic install recipe for the Infrastructure agent on Windows
repository: https://github.com/newrelic/infrastructure-agent

# See http://download.newrelic.com/infrastructure_agent/ for possible permutations
installTargets:
  - type: host
    os: windows

# keyword convention for dealing with search terms that could land someone on this instrumentation project
keywords:
  - Infrastructure
  - Agent
  - Windows

# Examine Infrastructure events for correlated data
processMatch:

validationNrql: "SELECT count(*) from SystemSample where hostname like 'HOSTNAME' SINCE 10 minutes ago"

# go-task yaml definition goes here
# This spec - https://github.com/go-task/task
install:
  version: "3"
  silent: true
  tasks:
    default:
      cmds:
        - task: remove_any_previous
        - task: install

    remove_any_previous:
      ignore_error: true
      cmds:
        - net stop newrelic-infra
        - $app = Get-WmiObject -Class Win32_Product -Filter "Name = 'New Relic Infrastructure Agent'"; $app.Uninstall()

    install:
      cmds:
        - (New-Object System.Net.WebClient).DownloadFile("https://download.newrelic.com/infrastructure_agent/windows/newrelic-infra.msi", "$env:TEMP\newrelic-infra.msi"); 
        - $LICENSE_KEY="{{.NR_LICENSE_KEY}}"; msiexec.exe /qn /i "$env:TEMP\newrelic-infra.msi" GENERATE_CONFIG=true LICENSE_KEY="$LICENSE_KEY" | Out-Null;
        - (New-Object System.Net.WebClient).DownloadFile("https://aka.ms/vs/16/release/vc_redist.x64.exe", "$env:TEMP\vc_redist.x64.exe");
        - start-process -FilePath "$env:TEMP\vc_redist.x64.exe" -ArgumentList "/install /q /norestart" -Verb RunAs -wait | Out-Null;
        - New-Item "C:\\Program Files\\New Relic\\newrelic-infra\\logging.d\\logs.yml" -ItemType File -Value "logs:" -Force
        - Add-Content "C:\\Program Files\\New Relic\\newrelic-infra\\logging.d\\logs.yml" "  - name: windows-security"
        - Add-Content "C:\\Program Files\\New Relic\\newrelic-infra\\logging.d\\logs.yml" "    winlog:"
        - Add-Content "C:\\Program Files\\New Relic\\newrelic-infra\\logging.d\\logs.yml" "      channel: Security"
        - Add-Content "C:\\Program Files\\New Relic\\newrelic-infra\\logging.d\\logs.yml" "      collect-eventids:"
        - Add-Content "C:\\Program Files\\New Relic\\newrelic-infra\\logging.d\\logs.yml" "      - 4624"
        - Add-Content "C:\\Program Files\\New Relic\\newrelic-infra\\logging.d\\logs.yml" "      - 4265"
        - Add-Content "C:\\Program Files\\New Relic\\newrelic-infra\\logging.d\\logs.yml" "      - 4700-4800"
        - Add-Content "C:\\Program Files\\New Relic\\newrelic-infra\\logging.d\\logs.yml" "      exclude-eventids:"
        - Add-Content "C:\\Program Files\\New Relic\\newrelic-infra\\logging.d\\logs.yml" "      - 4735"
        - Add-Content "C:\\Program Files\\New Relic\\newrelic-infra\\logging.d\\logs.yml" "      - 4097"
        - Add-Content "C:\\Program Files\\New Relic\\newrelic-infra\\logging.d\\logs.yml" "  - name: windows-application"
        - Add-Content "C:\\Program Files\\New Relic\\newrelic-infra\\logging.d\\logs.yml" "    winlog:"
        - Add-Content "C:\\Program Files\\New Relic\\newrelic-infra\\logging.d\\logs.yml" "      channel: Application"
        - net start newrelic-infra
        - echo "New Relic infrastructure agent for Windows installed and started"
